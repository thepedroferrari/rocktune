# Menu System Module
# Provides interactive CLI menu functionality for user selection

<#
.SYNOPSIS
    Interactive menu system for Gaming PC Setup

.DESCRIPTION
    Provides functions for creating checkbox-style menus, category selection,
    and user input validation with visual indicators ([*] recommended, [!] warning, [i] info)
#>

# ============================================================================
# MENU RENDERING FUNCTIONS
# ============================================================================

function Show-Menu {
    <#
    .SYNOPSIS
        Displays an interactive menu with checkbox-style selection

    .PARAMETER Title
        Menu title to display at top

    .PARAMETER Options
        Array of menu option objects with properties:
        - Label: Display text
        - Selected: Boolean for checkbox state
        - Icon: Optional icon ([*] [!] [i])
        - Description: Optional description text
        - Disabled: Optional boolean to gray out option

    .PARAMETER Legend
        Optional legend text to display at bottom

    .PARAMETER AllowMultiple
        If true, user can toggle multiple items. If false, single selection only.

    .EXAMPLE
        $options = @(
            @{ Label = "Enable HPET Disable"; Selected = $true; Icon = "[*]"; Description = "Recommended" }
            @{ Label = "Enable MSI Mode"; Selected = $true; Icon = "[*]" }
        )
        $selected = Show-Menu -Title "Performance Options" -Options $options -Legend "[*] = Recommended"
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Title,

        [Parameter(Mandatory=$true)]
        [array]$Options,

        [string]$Legend = "",

        [bool]$AllowMultiple = $true
    )

    $selectedIndices = @()

    do {
        Clear-Host

        # Draw border
        Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
        Write-Host "    $Title" -ForegroundColor Cyan
        Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
        Write-Host ""

        # Draw menu items
        for ($i = 0; $i -lt $Options.Count; $i++) {
            $option = $Options[$i]
            $index = $i + 1

            # Checkbox
            $checkbox = if ($option.Selected) { "X" } else { " " }

            # Icon
            $icon = if ($option.Icon) { " $($option.Icon)" } else { "" }

            # Color based on state
            $color = "White"
            if ($option.Disabled) {
                $color = "DarkGray"
            } elseif ($option.Icon -eq "[*]") {
                $color = "Green"
            } elseif ($option.Icon -eq "[!]") {
                $color = "Yellow"
            } elseif ($option.Icon -eq "[i]") {
                $color = "Cyan"
            }

            # Format line
            $line = " [$checkbox] $index. $($option.Label)$icon"
            Write-Host $line -ForegroundColor $color

            # Description (if provided)
            if ($option.Description) {
                Write-Host "      $($option.Description)" -ForegroundColor DarkGray
            }
        }

        # Legend
        if ($Legend) {
            Write-Host ""
            Write-Host "Legend: $Legend" -ForegroundColor DarkGray
        }

        # Instructions
        Write-Host ""
        Write-Host "Toggle with numbers, 'A' for all, 'N' for none, 'R' for recommended, Enter to continue" -ForegroundColor Yellow

        # Get input
        $choice = Read-Host "Your choice"

        # Process input
        if ($choice -match '^\d+$') {
            # Numeric selection - toggle item
            $idx = [int]$choice - 1
            if ($idx -ge 0 -and $idx -lt $Options.Count -and -not $Options[$idx].Disabled) {
                $Options[$idx].Selected = -not $Options[$idx].Selected
            }
        }
        elseif ($choice -eq 'A' -or $choice -eq 'a') {
            # Select all
            for ($i = 0; $i -lt $Options.Count; $i++) {
                if (-not $Options[$i].Disabled) {
                    $Options[$i].Selected = $true
                }
            }
        }
        elseif ($choice -eq 'N' -or $choice -eq 'n') {
            # Select none
            for ($i = 0; $i -lt $Options.Count; $i++) {
                $Options[$i].Selected = $false
            }
        }
        elseif ($choice -eq 'R' -or $choice -eq 'r') {
            # Select recommended only
            for ($i = 0; $i -lt $Options.Count; $i++) {
                $Options[$i].Selected = ($Options[$i].Icon -eq "[*]")
            }
        }
        elseif ($choice -eq '') {
            # Enter pressed - confirm selection
            break
        }

    } while ($true)

    # Return selected indices
    $selectedIndices = @()
    for ($i = 0; $i -lt $Options.Count; $i++) {
        if ($Options[$i].Selected) {
            $selectedIndices += $i
        }
    }

    return $selectedIndices
}

function Show-CategoryMenu {
    <#
    .SYNOPSIS
        Shows top-level category selection menu

    .PARAMETER Categories
        Hashtable of categories with metadata:
        - Key: Category name
        - Value: @{ ItemCount = 10; Icon = "[PERF]"; Recommended = 8 }

    .EXAMPLE
        $categories = @{
            "Performance" = @{ ItemCount = 10; Icon = "[PERF]"; Recommended = 8 }
            "Privacy" = @{ ItemCount = 8; Icon = "[PRIV]"; Recommended = 6 }
        }
        $selected = Show-CategoryMenu -Categories $categories
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [hashtable]$Categories
    )

    # Convert hashtable to array of options
    $options = @()
    $index = 0
    foreach ($key in $Categories.Keys) {
        $cat = $Categories[$key]
        $options += @{
            Label = "$($cat.Icon) $key"
            Selected = $true  # Default: all selected
            Description = "$($cat.ItemCount) items ($($cat.Recommended) recommended)"
            Icon = ""
        }
        $index++
    }

    # Show menu
    $selectedIndices = Show-Menu -Title "SELECT CATEGORIES" -Options $options -AllowMultiple $true

    # Return selected category names
    $categoryKeys = @($Categories.Keys)
    $selectedCategories = @()
    foreach ($idx in $selectedIndices) {
        $selectedCategories += $categoryKeys[$idx]
    }

    return $selectedCategories
}

function Get-UserChoice {
    <#
    .SYNOPSIS
        Gets validated user input for simple choices

    .PARAMETER Prompt
        Question to ask user

    .PARAMETER ValidChoices
        Array of valid inputs (e.g., @('1', '2', '3', 'Y', 'N'))

    .PARAMETER DefaultChoice
        Default value if user presses Enter

    .EXAMPLE
        $choice = Get-UserChoice -Prompt "Continue?" -ValidChoices @('Y', 'N') -DefaultChoice 'Y'
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Prompt,

        [Parameter(Mandatory=$true)]
        [array]$ValidChoices,

        [string]$DefaultChoice = ""
    )

    do {
        $validString = $ValidChoices -join '/'
        if ($DefaultChoice) {
            $fullPrompt = "$Prompt [$validString, default=$DefaultChoice]"
        } else {
            $fullPrompt = "$Prompt [$validString]"
        }

        $choice = Read-Host $fullPrompt

        # Use default if empty
        if ($choice -eq '' -and $DefaultChoice) {
            $choice = $DefaultChoice
        }

        # Check if valid
        if ($ValidChoices -contains $choice) {
            return $choice
        }

        Write-Host "Invalid choice. Please select from: $validString" -ForegroundColor Red

    } while ($true)
}

function Show-Summary {
    <#
    .SYNOPSIS
        Displays configuration summary before execution

    .PARAMETER Config
        Configuration hashtable to display

    .PARAMETER Title
        Summary title

    .EXAMPLE
        Show-Summary -Title "Configuration Summary" -Config $userConfig
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Title,

        [Parameter(Mandatory=$true)]
        [hashtable]$Config
    )

    Clear-Host
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "    $Title" -ForegroundColor Cyan
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""

    foreach ($category in $Config.Keys | Sort-Object) {
        Write-Host "${category}:" -ForegroundColor Yellow
        $items = $Config[$category]

        if ($items -is [hashtable]) {
            foreach ($key in $items.Keys | Sort-Object) {
                $value = $items[$key]
                $status = if ($value -eq $true) { "YES" } elseif ($value -eq $false) { "NO" } else { $value }
                Write-Host "  $key : $status" -ForegroundColor White
            }
        } elseif ($items -is [array]) {
            foreach ($item in $items) {
                Write-Host "  - $item" -ForegroundColor White
            }
        } else {
            Write-Host "  $items" -ForegroundColor White
        }

        Write-Host ""
    }

    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
}

function Show-Welcome {
    <#
    .SYNOPSIS
        Displays welcome screen with system information

    .PARAMETER SystemInfo
        Hashtable containing system information (RAM, CPU, OS, etc.)
    #>

    [CmdletBinding()]
    param(
        [hashtable]$SystemInfo = @{}
    )

    Clear-Host
    Write-Host ""
    Write-Host "??\u0022?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "???                                                                              ???" -ForegroundColor Cyan
    Write-Host "???              GAMING PC SETUP - INTERACTIVE CONFIGURATION                     ???" -ForegroundColor Cyan
    Write-Host "???                                                                              ???" -ForegroundColor Cyan
    Write-Host "????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "Welcome! This wizard will optimize your Windows system for gaming." -ForegroundColor White
    Write-Host ""

    if ($SystemInfo.Count -gt 0) {
        Write-Host "System Information:" -ForegroundColor Yellow
        foreach ($key in $SystemInfo.Keys) {
            Write-Host "  $key : $($SystemInfo[$key])" -ForegroundColor White
        }
        Write-Host ""
    }
}

function Show-SetupModeSelection {
    <#
    .SYNOPSIS
        Shows initial setup mode selection (Express/Custom/Profile)

    .OUTPUTS
        String: "express", "custom", or "profile"
    #>

    Clear-Host
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host "    SETUP MODE SELECTION" -ForegroundColor Cyan
    Write-Host "?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "Choose your setup mode:" -ForegroundColor Yellow
    Write-Host ""
    Write-Host "  1) Express Setup (Recommended)" -ForegroundColor Green
    Write-Host "     - Uses proven defaults" -ForegroundColor DarkGray
    Write-Host "     - ~5 minutes setup time" -ForegroundColor DarkGray
    Write-Host "     - Best for most users" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  2) Custom Setup (Advanced)" -ForegroundColor Yellow
    Write-Host "     - Select each optimization individually" -ForegroundColor DarkGray
    Write-Host "     - ~15 minutes setup time" -ForegroundColor DarkGray
    Write-Host "     - Full control over every setting" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  3) Load Profile" -ForegroundColor Cyan
    Write-Host "     - Pre-made configurations" -ForegroundColor DarkGray
    Write-Host "     - Competitive / Balanced / Privacy-Focused" -ForegroundColor DarkGray
    Write-Host ""
    Write-Host "  4) Exit" -ForegroundColor Red
    Write-Host ""

    $choice = Get-UserChoice -Prompt "Your choice" -ValidChoices @('1', '2', '3', '4') -DefaultChoice '1'

    switch ($choice) {
        '1' { return "express" }
        '2' { return "custom" }
        '3' { return "profile" }
        '4' { return "exit" }
    }
}

# ============================================================================
# EXPORT FUNCTIONS
# ============================================================================

Export-ModuleMember -Function @(
    'Show-Menu',
    'Show-CategoryMenu',
    'Get-UserChoice',
    'Show-Summary',
    'Show-Welcome',
    'Show-SetupModeSelection'
)


